<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WindowServer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.4) 0%, rgba(20, 20, 20, 0.5) 100%);
            -webkit-app-region: drag;
            color: white;
        }
        .content-area {
            -webkit-app-region: no-drag;
        }
        .markdown-content {
            line-height: 1.5;
            color: white;
            font-size: 0.875rem; /* 14px - smaller but readable */
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
            font-weight: bold;
            color: white;
        }
        .markdown-content h1 { font-size: 1.2rem; } /* Smaller headers */
        .markdown-content h2 { font-size: 1.1rem; }
        .markdown-content h3 { font-size: 1rem; }
        .markdown-content p { margin-bottom: 0.8rem; color: white; font-size: 0.875rem; }
        .markdown-content ul, .markdown-content ol { margin-bottom: 0.8rem; padding-left: 1.2rem; font-size: 0.875rem; }
        .markdown-content li { margin-bottom: 0.4rem; color: white; font-size: 0.875rem; }
        .markdown-content code { 
            background-color: rgba(0, 0, 0, 0.4); 
            padding: 0.2rem 0.4rem; 
            border-radius: 0.25rem; 
            font-family: 'Courier New', monospace;
            color: #e5e7eb;
        }
        .markdown-content pre { 
            background-color: rgba(0, 0, 0, 0.4); 
            padding: 1rem; 
            border-radius: 0.5rem; 
            margin: 1rem 0;
            overflow-x: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .markdown-content pre code { 
            background-color: transparent; 
            padding: 0; 
            color: #e5e7eb;
        }
        .markdown-content blockquote { 
            border-left: 4px solid #6b7280; 
            padding-left: 1rem; 
            margin: 1rem 0;
            font-style: italic;
            color: #d1d5db;
        }
        .split-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            height: calc(100vh - 1.5rem);
            padding: 0.75rem;
            overflow: hidden;
        }
        .text-panel, .code-panel {
            overflow-y: auto;
            overflow-x: auto;
            padding: 0.75rem;
            border-radius: 0.375rem;
            background-color: rgba(0, 0, 0, 0);
            border-radius: 0.375rem;
            max-height: 100%;
        }
        
        /* Show minimal scrollbars for better UX */
        .text-panel::-webkit-scrollbar, .code-panel::-webkit-scrollbar, .full-content::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        .text-panel::-webkit-scrollbar-track, .code-panel::-webkit-scrollbar-track, .full-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        
        .text-panel::-webkit-scrollbar-thumb, .code-panel::-webkit-scrollbar-thumb, .full-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }
        
        .text-panel::-webkit-scrollbar-thumb:hover, .code-panel::-webkit-scrollbar-thumb:hover, .full-content::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        /* Enable smooth scrolling always, better responsiveness when interactive */
        .text-panel, .code-panel, .full-content {
            scroll-behavior: smooth;
            overflow-y: auto;
            overflow-x: auto;
        }
        
        /* Enhanced scrolling when interactive */
        .interactive-scrolling .text-panel, 
        .interactive-scrolling .code-panel, 
        .interactive-scrolling .full-content {
            scroll-behavior: smooth;
        }
        .text-panel {
          background-color: rgba(0, 0, 0, 0);
        }
        .code-panel {
            background-color: rgba(0, 0, 0, 0);
        }
        .code-block {
            background-color: rgba(0, 0, 0, 0); 
            margin-bottom: 0.75rem;
        }
        .code-header {
            background-color: rgba(0, 0, 0, 0);
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem 0.375rem 0 0;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            color: #d1d5db;
        }
        .code-content {
            padding: 0.75rem;
            overflow-x: auto;
            background-color: rgba(0, 0, 0, 0);
        }
        .code-content pre {
            background-color: transparent;
            border: none;
            margin: 0;
            padding: 0;
        }
        .code-content code {
            background-color: transparent;
            color: #e5e7eb;
        }
        .no-code {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #9ca3af;
            font-style: italic;
        }
        .skill-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: bold;
            backdrop-filter: blur(10px);
            z-index: 1000;
        }
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
        }
        
        .loading-compact {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 200px;
            height: 60px;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.4) 0%, rgba(20, 20, 20, 0.5) 100%);
            backdrop-filter: blur(25px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.15);
        }
        
        .dots-container {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .bouncing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #4CAF50;
            animation: bounce 1.4s infinite ease-in-out;
        }
        
        .bouncing-dot:nth-child(1) { animation-delay: -0.32s; }
        .bouncing-dot:nth-child(2) { animation-delay: -0.16s; }
        .bouncing-dot:nth-child(3) { animation-delay: 0s; }
        
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
        .response-content {
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
            min-height: 100vh;
        }
        .ocr-section {
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            margin: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .full-content {
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
            margin: 0.75rem;
            padding: 1rem;
            border-radius: 0.375rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            height: calc(100vh - 1.5rem);
            overflow-y: auto;
            overflow-x: auto;
        }
        /* Override Prism theme for better visibility */
        .token.comment,
        .token.prolog,
        .token.doctype,
        .token.cdata {
            color: #6a737d;
        }
        
        .token.punctuation {
            color: #e1e4e8;
        }
        
        .token.property,
        .token.tag,
        .token.boolean,
        .token.number,
        .token.constant,
        .token.symbol,
        .token.deleted {
            color: #79b8ff;
        }
        
        .token.selector,
        .token.attr-name,
        .token.string,
        .token.char,
        .token.builtin,
        .token.inserted {
            color: #85e89d;
        }
        
        .token.operator,
        .token.entity,
        .token.url,
        .language-css .token.string,
        .style .token.string {
            color: #f97583;
        }
        
        .token.atrule,
        .token.attr-value,
        .token.keyword {
            color: #f97583;
        }
        
        .token.function,
        .token.class-name {
            color: #b392f0;
        }
        
        .token.regex,
        .token.important,
        .token.variable {
            color: #ffab70;
        }
        
        .token.important,
        .token.bold {
            font-weight: bold;
        }
        
        .token.italic {
            font-style: italic;
        }
        
        .token.entity {
            cursor: help;
        }
    </style>
</head>
<body class="text-white">
    <!-- Loading State -->
    <div id="loading" class="loading">
        <div class="loading-compact">
            <span class="text-gray-300 text-sm font-medium mr-2">Generating</span>
            <div class="dots-container">
                <div class="bouncing-dot"></div>
                <div class="bouncing-dot"></div>
                <div class="bouncing-dot"></div>
            </div>
        </div>
    </div>

    <!-- Response Content -->
    <div id="response-content" class="response-content hidden">
        <!-- Split Layout -->
        <div id="split-layout" class="split-layout">
            <!-- Text Panel -->
            <div class="text-panel">
                <div id="text-content" class="markdown-content"></div>
            </div>

            <!-- Code Panel -->
            <div class="code-panel">
                <div id="code-content"></div>
            </div>
        </div>

        <!-- Full Content (when no code detected) -->
        <div id="full-content" class="full-content hidden">
            <div id="full-markdown" class="markdown-content"></div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        
        let currentLayout = 'split';
        let hasCode = false;
        let currentSkill = 'dsa';
        let isInteractive = false;

        // Configure marked for better rendering
        marked.setOptions({
            highlight: function(code, lang) {
                if (Prism.languages[lang]) {
                    return Prism.highlight(code, Prism.languages[lang], lang);
                }
                return code;
            },
            breaks: true,
            gfm: true
        });

        // Test if window is working
        console.log('LLM Response window loaded');
        console.log('ipcRenderer available:', typeof ipcRenderer !== 'undefined');
        
        // Set up event listeners using direct ipcRenderer
        ipcRenderer.on('show-loading', (event) => {
            console.log('Showing loading state');
            showLoadingState();
        });

        ipcRenderer.on('display-llm-response', (event, data) => {
            console.log('LLM Response window received data:', data);
            console.log('Response length:', data.response ? data.response.length : 0);
            console.log('Skill:', data.skill);
            console.log('Window size before display:', window.innerWidth, 'x', window.innerHeight);
            
            // Check if window is still small (compact size) and request expansion
            if (window.innerWidth < 500 || window.innerHeight < 300) {
                console.log('Window appears to still be compact size, requesting expansion...');
                ipcRenderer.send('expand-llm-window');
                
                // Wait a bit for expansion, then display content
                setTimeout(() => {
                    console.log('Window size after expansion request:', window.innerWidth, 'x', window.innerHeight);
                    hideLoadingState();
                    displayResponse(data);
                }, 300);
            } else {
                console.log('Window is already expanded, displaying content immediately');
                hideLoadingState();
                displayResponse(data);
            }
        });

        // Handle interaction state changes
        ipcRenderer.on('interaction-enabled', () => {
            isInteractive = true;
            document.body.classList.add('interactive-scrolling');
            console.log('LLM Response window - Interactive mode enabled');
        });

        ipcRenderer.on('interaction-disabled', () => {
            isInteractive = false;
            document.body.classList.remove('interactive-scrolling');
            console.log('LLM Response window - Interactive mode disabled');
        });

        function showLoadingState() {
            const loadingElement = document.getElementById('loading');
            const responseElement = document.getElementById('response-content');
            
            if (loadingElement) {
                loadingElement.classList.remove('hidden');
            }
            
            if (responseElement) {
                responseElement.classList.add('hidden');
            }
        }

        function hideLoadingState() {
            const loadingElement = document.getElementById('loading');
            if (loadingElement) {
                loadingElement.classList.add('hidden');
            }
        }

        function displayResponse(data) {
            console.log('displayResponse called with data:', data);
            
            // Show content
            const responseElement = document.getElementById('response-content');
            
            console.log('Response element:', responseElement);
            
            if (responseElement) {
                responseElement.classList.remove('hidden');
                console.log('Response content shown');
            }

            // Parse the response
            const response = data.response;
            console.log('Response to parse:', response ? response.substring(0, 200) + '...' : 'No response');
            
            if (!response) {
                console.error('No response data received');
                return;
            }
            
            // Check if response contains code blocks
            const codeBlocks = extractCodeBlocks(response);
            hasCode = codeBlocks.length > 0;
            console.log('Code blocks found:', codeBlocks.length);

            if (hasCode) {
                // Split layout: text on left, code on right
                console.log('Using split layout');
                displaySplitLayout(response, codeBlocks);
            } else {
                // Full layout: all content in one panel
                console.log('Using full layout');
                displayFullLayout(response);
            }
            
            // Force a reflow to ensure content is visible
            setTimeout(() => {
                if (hasCode) {
                    const textPanel = document.querySelector('.text-panel');
                    const codePanel = document.querySelector('.code-panel');
                    if (textPanel) textPanel.scrollTop = 0;
                    if (codePanel) codePanel.scrollTop = 0;
                } else {
                    const fullContent = document.getElementById('full-content');
                    if (fullContent) fullContent.scrollTop = 0;
                }
            }, 100);
        }

        function extractCodeBlocks(text) {
            const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;
            const blocks = [];
            let match;

            while ((match = codeBlockRegex.exec(text)) !== null) {
                blocks.push({
                    language: match[1] || 'text',
                    code: match[2].trim(),
                    fullMatch: match[0]
                });
            }

            return blocks;
        }

        function displaySplitLayout(response, codeBlocks) {
            // Show split layout, hide full layout
            document.getElementById('split-layout').classList.remove('hidden');
            document.getElementById('full-content').classList.add('hidden');

            // Remove code blocks from text content
            let textContent = response;
            codeBlocks.forEach(block => {
                textContent = textContent.replace(block.fullMatch, '');
            });

            // Clean up text content
            textContent = textContent.replace(/\n\s*\n\s*\n/g, '\n\n').trim();

            // Render text content
            const textHtml = marked.parse(textContent);
            document.getElementById('text-content').innerHTML = textHtml;

            // Render code blocks
            const codeContainer = document.getElementById('code-content');
            codeContainer.innerHTML = '';

            if (codeBlocks.length === 0) {
                codeContainer.innerHTML = '<div class="no-code">No code examples found</div>';
            } else {
                codeBlocks.forEach((block, index) => {
                    const codeBlock = document.createElement('div');
                    codeBlock.className = 'code-block';
                    codeBlock.innerHTML = `
                        <div class="code-header">${block.language.toUpperCase()}</div>
                        <div class="code-content">
                            <pre><code class="language-${block.language}">${escapeHtml(block.code)}</code></pre>
                        </div>
                    `;
                    codeContainer.appendChild(codeBlock);
                });
            }

            // Highlight code
            Prism.highlightAll();
        }

        function displayFullLayout(response) {
            // Show full layout, hide split layout
            document.getElementById('split-layout').classList.add('hidden');
            document.getElementById('full-content').classList.remove('hidden');

            // Render full markdown
            const html = marked.parse(response);
            document.getElementById('full-markdown').innerHTML = html;

            // Highlight any code
            Prism.highlightAll();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Handle window focus
        window.addEventListener('focus', () => {
            console.log('LLM Response window focused');
        });

        // Handle window close
        window.addEventListener('beforeunload', () => {
            console.log('LLM Response window closing');
        });

        // Add keyboard scrolling support
        document.addEventListener('keydown', (e) => {
            if (!isInteractive) return;
            
            const activeElement = document.activeElement;
            let targetElement = null;
            
            // Determine which panel to scroll
            if (hasCode) {
                // In split layout, determine which panel has focus or default to text panel
                targetElement = document.querySelector('.text-panel');
                if (activeElement && activeElement.closest('.code-panel')) {
                    targetElement = document.querySelector('.code-panel');
                }
            } else {
                // In full layout
                targetElement = document.querySelector('.full-content');
            }
            
            if (!targetElement) return;
            
            const scrollAmount = 50; // Pixels to scroll
            
            switch(e.key) {
                case 'ArrowUp':
                    e.preventDefault();
                    targetElement.scrollBy({ top: -scrollAmount, behavior: 'smooth' });
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    targetElement.scrollBy({ top: scrollAmount, behavior: 'smooth' });
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    targetElement.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    targetElement.scrollBy({ left: scrollAmount, behavior: 'smooth' });
                    break;
                case 'PageUp':
                    e.preventDefault();
                    targetElement.scrollBy({ top: -targetElement.clientHeight * 0.8, behavior: 'smooth' });
                    break;
                case 'PageDown':
                    e.preventDefault();
                    targetElement.scrollBy({ top: targetElement.clientHeight * 0.8, behavior: 'smooth' });
                    break;
                case 'Home':
                    e.preventDefault();
                    targetElement.scrollTo({ top: 0, behavior: 'smooth' });
                    break;
                case 'End':
                    e.preventDefault();
                    targetElement.scrollTo({ top: targetElement.scrollHeight, behavior: 'smooth' });
                    break;
            }
        });

        // Enhanced scrolling support - always allow scrolling, but enhanced when interactive
        let scrollSensitivity = 2; // Adjust scroll speed

        function handleWheelEvent(e) {
            // Allow scrolling even when not interactive, but with different behavior
            const target = e.currentTarget;
            const deltaX = e.deltaX * scrollSensitivity;
            const deltaY = e.deltaY * scrollSensitivity;
            
            if (isInteractive) {
                // Enhanced smooth scrolling when interactive
                e.preventDefault();
                target.scrollBy({
                    left: deltaX,
                    top: deltaY,
                    behavior: 'smooth'
                });
            } else {
                // Allow natural scrolling when not interactive (don't prevent default)
                // This allows normal mouse wheel scrolling to work
                console.log('Scroll event in non-interactive mode - allowing natural scroll');
            }
        }

        // Add enhanced scrolling to all scrollable containers
        document.addEventListener('DOMContentLoaded', () => {
            const scrollableElements = [
                document.getElementById('text-content'),
                document.getElementById('code-content'), 
                document.getElementById('full-content'),
                document.querySelector('.text-panel'),
                document.querySelector('.code-panel')
            ].filter(el => el !== null);

            scrollableElements.forEach(element => {
                element.addEventListener('wheel', handleWheelEvent, { passive: false });
            });
        });
    </script>
</body>
</html> 